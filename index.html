import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, getDocs } from 'firebase/firestore';
import { 
  User, Mail, Building2, Users, FileText, Globe, Video, Link, Briefcase, PlusCircle, Trash2, ShieldOff, Hash,
  // Icons for status, loading, and expand/collapse
  Loader2, CheckCircle, AlertTriangle, ChevronDown, ChevronUp 
} from 'lucide-react';

// --- FIREBASE SETUP (DO NOT MODIFY THESE GLOBAL VARIABLES) ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
// --- END FIREBASE SETUP ---

// --- MOCK DATA FOR DEMO ---
const createMockApplications = (appId, userId) => {
    const baseData = {
        timestamp: serverTimestamp(),
        submitterId: userId,
    };

    return [
        // 1. Individual Applicant (Requires Video)
        {
            ...baseData,
            type: 'Individual',
            name: 'Jane K. Doe (The Guardian)',
            contactEmail: 'jane.k.doe@example.com',
            geographicRepresentation: 'Western Europe',
            biography: 'Jane has over 15 years of experience in international legal frameworks and constitutional law, specializing in digital rights and decentralized systems. Her academic work focuses on the intersection of privacy, sovereignty, and cryptoeconomic systems.',
            conflictOfInterest: 'Holds stock in major tech company X, currently in a blind trust.',
            stakeId: 'stake1ux0e...xyz7b',
            drepId: 'drep1y829...d7s4e',
            socialProfile: '@JaneK_Guardian',
            proofOfLifeVideoLink: 'https://youtube.com/watch?v=janedoe_video',
            skipVideo: false,
            motivation: 'To ensure the core constitutional document remains decentralized, resilient, and protects the fundamental rights of all users, focusing on long-term systemic stability.',
            relevantExperience: 'Drafted policy recommendations for UN bodies on digital sovereignty; served on three previous governance committees, leading the documentation working group.',
            communicationApproach: 'Weekly public forum posts, monthly Q&A sessions on Discord, and direct email contact for high-priority issues. Commitment to 100% transparent voting record.',
        },
        // 2. Individual Applicant (Skips Video)
        {
            ...baseData,
            type: 'Individual',
            name: 'Dr. John P. Smith',
            contactEmail: 'john.smith@university.edu',
            geographicRepresentation: 'North America',
            biography: 'Professor of Political Science focusing on digital democracy and distributed ledger technology governance models at State University. His research informs policy makers globally on fair election systems.',
            conflictOfInterest: 'None Declared',
            stakeId: 'N/A',
            drepId: 'N/A',
            socialProfile: 'https://linkedin.com/in/johnsmith',
            proofOfLifeVideoLink: 'Skipped (Prior Applicant)',
            skipVideo: true,
            motivation: 'To bridge academic theory with practical, decentralized governance implementation, ensuring the constitution is legally sound and philosophically coherent.',
            relevantExperience: 'Authored seminal book on blockchain governance; advised multiple foundational layer protocols on establishing initial governance structures.',
            communicationApproach: 'Primarily through published long-form articles and engagement during scheduled governance meetings, with an open-door policy for academic review.',
        },
        // 3. Company Applicant
        {
            ...baseData,
            type: 'Company',
            name: 'Global Governance Corp',
            contactEmail: 'contact@globalgov.com',
            primaryContactPerson: 'Alice Johnson',
            organizationDescription: 'A global consulting firm specializing in decentralized finance regulation and protocol security, employing 50+ staff across three continents. Focus on risk mitigation and long-term viability.',
            conflictOfInterest: 'Provides security auditing services to a major DApp developer.',
            proofOfLifeVideoLink: 'Organizational video link for validation: https://vimeo.com/globalgovcorp_proof',
            governanceExperience: 'Active participant and proposal submitter in 5 large-scale DeFi DAOs, contributing code and documentation standards. We have a dedicated team for governance research.',
            communicationApproach: 'Dedicated transparency portal hosted on our corporate site; formal updates posted bi-weekly via email newsletter and forum posts.',
            whyServe: 'To bring professional regulatory and security analysis expertise to the foundational governance document, ensuring stability and compliance with evolving global standards.',
        },
        // 4. Organization Applicant
        {
            ...baseData,
            type: 'Company',
            name: 'Blockchain Integrity DAO',
            contactEmail: 'governance@integritydao.org',
            primaryContactPerson: 'Bob Williams',
            organizationDescription: 'A non-profit organization focused on promoting ethical and transparent blockchain development, advocating for community access and fair treatment.',
            conflictOfInterest: 'None Declared',
            proofOfLifeVideoLink: 'Video presentation describing the DAO structure and mission (Available via private cloud link).',
            governanceExperience: 'Successfully led three community-funded governance campaigns focused on fund allocation and dispute resolution, proving grassroots effectiveness.',
            communicationApproach: 'Open-source documentation and real-time public chat channels for continuous community feedback, adhering strictly to a public-first policy.',
            whyServe: 'To represent the interests of non-commercial community members and uphold high standards of ethical conduct and decentralization principles.',
        },
        // 5. Consortium Applicant (Future Think Tank)
        {
            ...baseData,
            type: 'Consortium',
            name: 'The Future Think Tank',
            contactEmail: 'consortium@futurethink.org',
            primaryContactPerson: 'Dr. Emily Clark',
            consortiumMission: 'To research and deploy futuristic, scalable governance solutions that anticipate technological and societal changes over the next decade.',
            consortiumValues: 'Innovation, Scalability, Decentralization.',
            members: [
                {
                    name: 'Member 1 (Tech Lead)',
                    geographicRepresentation: 'Asia Pacific',
                    biography: 'Expert in cryptography and consensus mechanisms, having published several peer-reviewed papers on protocol efficiency.',
                    conflictOfInterest: 'None Declared',
                    stakeId: 'stake123...',
                    drepId: 'drep123...',
                    socialProfile: 'N/A',
                    proofOfLifeVideoLink: 'https://video.link/member1-future',
                    skipVideo: false,
                },
                {
                    name: 'Member 2 (Legal Advisor)',
                    geographicRepresentation: 'EU',
                    biography: 'Practicing lawyer specializing in global treaties and digital asset compliance, providing critical foresight on legal risks.',
                    conflictOfInterest: 'Works part-time for EU regulatory body.',
                    stakeId: 'N/A',
                    drepId: 'N/A',
                    socialProfile: 'N/A',
                    proofOfLifeVideoLink: 'Skipped (Prior Applicant)',
                    skipVideo: true,
                }
            ]
        },
        // 6. Consortium Applicant (Justice Coalition)
        {
            ...baseData,
            type: 'Consortium',
            name: 'Decentralized Justice Coalition',
            contactEmail: 'justice@coalition.net',
            primaryContactPerson: 'Sarah Lee',
            consortiumMission: 'Focused on ensuring accessibility and fairness in governance for marginalized communities and promoting inclusion in all decision-making processes.',
            consortiumValues: 'Equity, Access, Inclusion.',
            members: [
                {
                    name: 'Member 1 (Community Organizer)',
                    geographicRepresentation: 'South America',
                    biography: 'Decades of experience in community organizing and advocacy, focusing on Latin American policy adoption and translation.',
                    conflictOfInterest: 'None Declared',
                    stakeId: 'N/A',
                    drepId: 'N/A',
                    socialProfile: '@Sarah_Community',
                    proofOfLifeVideoLink: 'https://vimeo.link/member1-justice',
                    skipVideo: false,
                }
            ]
        }
    ];
};
// --- END MOCK DATA ---

const App = () => {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submissionSuccess, setSubmissionSuccess] = useState(false);
  
  // New state to manage the expanded details view
  const [expandedId, setExpandedId] = useState(null); 

  // Form State - General
  const [registrationType, setRegistrationType] = useState('Individual');
  const [entityName, setEntityName] = useState(''); 
  const [contactEmail, setContactEmail] = useState(''); 

  // Individual Fields
  const [geographicRepresentation, setGeographicRepresentation] = useState('');
  const [biography, setBiography] = useState('');
  const [conflictOfInterest, setConflictOfInterest] = useState('');
  const [stakeId, setStakeId] = useState('');
  const [drepId, setDrepId] = useState('');
  const [socialProfile, setSocialProfile] = useState('');
  const [proofOfLifeVideoLink, setProofOfLifeVideoLink] = useState('');
  const [skipVideo, setSkipVideo] = useState(false); 
  const [motivation, setMotivation] = useState('');
  const [relevantExperience, setRelevantExperience] = useState('');
  const [communicationApproach, setCommunicationApproach] = useState('');

  // Company/Org Fields
  const [primaryContactPerson, setPrimaryContactPerson] = useState('');
  const [organizationDescription, setOrganizationDescription] = useState('');
  const [governanceExperience, setGovernanceExperience] = useState('');
  const [whyServe, setWhyServe] = useState('');

  // Consortium Fields
  const [consortiumMission, setConsortiumMission] = useState('');
  const [consortiumValues, setConsortiumValues] = useState('');
  const [consortiumMembers, setConsortiumMembers] = useState([]); 

  const [registrations, setRegistrations] = useState([]);

  // Toggle function for the expanded view
  const toggleExpand = (id) => {
    setExpandedId(expandedId === id ? null : id);
  };

  // --- Utility Functions for Consortium Members ---
  const addMember = () => {
    setConsortiumMembers([...consortiumMembers, {
      id: crypto.randomUUID(), 
      name: '',
      geographicRepresentation: '',
      biography: '',
      conflictOfInterest: '',
      stakeId: '',
      drepId: '',
      socialProfile: '',
      proofOfLifeVideoLink: '',
      skipVideo: false, 
    }]);
  };

  const removeMember = (id) => {
    setConsortiumMembers(consortiumMembers.filter(member => member.id !== id));
  };

  const updateMember = (id, field, value) => {
    setConsortiumMembers(consortiumMembers.map(member =>
      member.id === id ? { ...member, [field]: value } : member
    ));
  };
  // --- End Utility Functions ---

  // 1. Firebase Initialization and Authentication & Mock Data Injection
  useEffect(() => {
    const collectionPath = `/artifacts/${appId}/public/data/constitutional_committee_applications`;
    
    const addMockDataIfEmpty = async (firestore, currentUserId) => {
        try {
            const q = query(collection(firestore, collectionPath));
            const snapshot = await getDocs(q);
            
            // Only add mock data if the collection is empty
            if (snapshot.empty) {
                const mockApplications = createMockApplications(appId, currentUserId);
                for (const app of mockApplications) {
                    await addDoc(collection(firestore, collectionPath), app);
                }
                console.log("Mock data added successfully.");
            }
        } catch (e) {
            console.error("Error adding mock data:", e);
        }
    };

    const initializeFirebase = async () => {
      try {
        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);
        const authService = getAuth(app);

        setDb(firestore);
        setAuth(authService);

        let currentUserId = null;

        // Sign in using custom token or anonymously
        if (initialAuthToken) {
          const userCredential = await signInWithCustomToken(authService, initialAuthToken);
          currentUserId = userCredential.user.uid;
        } else {
          const userCredential = await signInAnonymously(authService);
          currentUserId = userCredential.user.uid;
        }

        // Set up Auth State Listener (for real-time updates)
        onAuthStateChanged(authService, (user) => {
          const finalUserId = user ? user.uid : crypto.randomUUID();
          setUserId(finalUserId);
          setLoading(false);
          
          // Inject mock data *after* auth is ready and user ID is set
          if (firestore) {
             addMockDataIfEmpty(firestore, finalUserId);
          }
        });
        
      } catch (e) {
        console.error("Firebase Initialization Error:", e);
        setError("Failed to initialize the app. Check console for details.");
        setLoading(false);
      }
    };

    initializeFirebase();
  }, []);

  // 2. Real-time Data Listener (onSnapshot)
  useEffect(() => {
    if (!db || !userId) return;

    const collectionPath = `/artifacts/${appId}/public/data/constitutional_committee_applications`;
    const q = query(collection(db, collectionPath));

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const fetchedRegistrations = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      })).sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0)); // Sort newest first

      setRegistrations(fetchedRegistrations);
    }, (err) => {
      console.error("Firestore Listener Error:", err);
      setError("Failed to fetch registrations in real-time.");
    });

    // Cleanup listener on component unmount
    return () => unsubscribe();
  }, [db, userId]);

  // Form Validation
  const validateForm = () => {
    if (!entityName || !contactEmail) {
      return "Entity Name/Full Name and Primary Contact Email are required.";
    }
    if (!contactEmail.includes('@') || !contactEmail.includes('.')) {
      return "Please enter a valid email address for the Primary Contact.";
    }

    if (registrationType === 'Individual') {
      // Check required fields, but only check video link if skipVideo is false
      if (!biography || !motivation || !relevantExperience || !communicationApproach || (!skipVideo && !proofOfLifeVideoLink)) {
        return "Please complete all required fields for Individual registration (Biography, Video Link/Opt-out, Motivation, Experience, and Communication Approach).";
      }
    }

    if (registrationType === 'Company') {
      // For company, we assume the link/description is required regardless, as it relates to the organization
      if (!primaryContactPerson || !organizationDescription || !governanceExperience || !communicationApproach || !whyServe || !proofOfLifeVideoLink) {
        return "Please complete all required fields for Company/Organization registration (Contact Person, Description, Experience, Approach, Motivation, and Video Link/Description).";
      }
    }

    if (registrationType === 'Consortium') {
      if (!consortiumMembers.length) {
        return "A Consortium must list at least one member.";
      }
      const incompleteMember = consortiumMembers.some(member => 
        !member.name || 
        !member.biography || 
        (!member.skipVideo && !member.proofOfLifeVideoLink) // Check video link only if opt-out is false
      );
      if (incompleteMember) {
        return "All Consortium members must have a Name, Biography, and Proof-of-Life Video Link (or have opted out).";
      }
    }

    return null;
  };

  // 3. Submission Handler
  const handleSubmit = async (e) => {
    e.preventDefault();
    const validationError = validateForm();
    if (validationError) {
      setError(validationError);
      return;
    }

    if (!db) {
      setError('Database is not initialized.');
      return;
    }

    setIsSubmitting(true);
    setError('');
    setSubmissionSuccess(false);

    try {
      const collectionPath = `/artifacts/${appId}/public/data/constitutional_committee_applications`;
      let registrationData = {
        type: registrationType,
        name: entityName,
        contactEmail: contactEmail,
        timestamp: serverTimestamp(),
        submitterId: userId,
      };

      if (registrationType === 'Individual') {
        registrationData = {
          ...registrationData,
          geographicRepresentation,
          biography,
          conflictOfInterest: conflictOfInterest || 'None Declared',
          stakeId: stakeId || 'N/A',
          drepId: drepId || 'N/A',
          socialProfile: socialProfile || 'N/A',
          proofOfLifeVideoLink: skipVideo ? 'Skipped (Prior Applicant)' : proofOfLifeVideoLink,
          skipVideo,
          motivation,
          relevantExperience,
          communicationApproach,
        };
      } else if (registrationType === 'Company') {
        registrationData = {
          ...registrationData,
          primaryContactPerson,
          organizationDescription,
          conflictOfInterest: conflictOfInterest || 'None Declared',
          proofOfLifeVideoLink, 
          governanceExperience,
          communicationApproach,
          whyServe: whyServe,
        };
      } else if (registrationType === 'Consortium') {
        registrationData = {
          ...registrationData,
          consortiumContactPerson: primaryContactPerson,
          consortiumMission: consortiumMission || 'N/A',
          consortiumValues: consortiumValues || 'N/A',
          members: consortiumMembers.map(({ id, ...memberData }) => ({
            ...memberData,
            proofOfLifeVideoLink: memberData.skipVideo ? 'Skipped (Prior Applicant)' : memberData.proofOfLifeVideoLink
          })), 
        };
      }

      await addDoc(collection(db, collectionPath), registrationData);

      // Clear form on success
      setEntityName('');
      setContactEmail('');
      setRegistrationType('Individual');
      // Clear all specific fields
      setGeographicRepresentation(''); setBiography(''); setConflictOfInterest(''); setStakeId(''); setDrepId(''); setSocialProfile(''); 
      setProofOfLifeVideoLink(''); setSkipVideo(false); setMotivation(''); setRelevantExperience(''); setCommunicationApproach('');
      setPrimaryContactPerson(''); setOrganizationDescription(''); setGovernanceExperience(''); setWhyServe('');
      setConsortiumMission(''); setConsortiumValues(''); setConsortiumMembers([]);

      setSubmissionSuccess(true);
      setTimeout(() => setSubmissionSuccess(false), 5000);

    } catch (e) {
      console.error("Error submitting registration:", e);
      setError("An error occurred during submission. Please try again.");
    } finally {
      setIsSubmitting(false);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-50">
        <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
        <p className="ml-3 text-lg font-medium text-indigo-700">Loading Application...</p>
      </div>
    );
  }

  const baseInputClasses = "w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150";
  const requiredAsterisk = <span className="text-red-500">*</span>;

  // Helper component to render key-value pairs in the detailed view
  const DetailItem = ({ label, value, isLink = false }) => {
    if (!value || value === 'N/A') return null;
    return (
      <div className="text-sm border-b border-gray-100 py-2">
        <strong className="font-semibold text-gray-700">{label}:</strong>
        <span className="block text-gray-600 mt-1 pl-3 break-words">
            {isLink && value.startsWith('http') ? (
                <a href={value} target="_blank" rel="noopener noreferrer" className="text-indigo-600 hover:text-indigo-800 underline">
                    {value}
                </a>
            ) : (
                value
            )}
        </span>
      </div>
    );
  };
  
  // --- Render Detailed Application View ---
  const renderDetailedApplication = (reg) => {
    if (reg.type === 'Individual') {
        return (
            <div className="mt-4 pt-4 border-t border-gray-200 space-y-2">
                <h4 className="text-lg font-bold text-gray-800 mb-2">Detailed Individual Profile</h4>
                <DetailItem label="Full Name/Alias" value={reg.name} />
                <DetailItem label="Geographic Representation" value={reg.geographicRepresentation} />
                <DetailItem label="Stake ID" value={reg.stakeId} />
                <DetailItem label="DRep ID" value={reg.drepId} />
                <DetailItem label="Social / X Profile" value={reg.socialProfile} isLink={reg.socialProfile && reg.socialProfile.startsWith('http')} />
                
                <DetailItem label="Conflict of Interest" value={reg.conflictOfInterest} />

                <DetailItem label="Biography" value={reg.biography} />
                <DetailItem label="Motivation for Serving" value={reg.motivation} />
                <DetailItem label="Relevant Governance or Constitutional Experience" value={reg.relevantExperience} />
                <DetailItem label="Communication & Transparency Approach" value={reg.communicationApproach} />

                <DetailItem 
                    label="Proof-of-Life Video Link" 
                    value={reg.skipVideo ? 'Skipped (Prior Applicant - Follow-up may be required)' : reg.proofOfLifeVideoLink} 
                    isLink={reg.proofOfLifeVideoLink && reg.proofOfLifeVideoLink.startsWith('http')}
                />
            </div>
        );
    } else if (reg.type === 'Company') {
        return (
            <div className="mt-4 pt-4 border-t border-gray-200 space-y-2">
                <h4 className="text-lg font-bold text-gray-800 mb-2">Detailed Organization Profile</h4>
                <DetailItem label="Company / Organization Name" value={reg.name} />
                <DetailItem label="Primary Contact Person" value={reg.primaryContactPerson} />
                <DetailItem label="Conflict of Interest" value={reg.conflictOfInterest} />

                <DetailItem label="Organization Description" value={reg.organizationDescription} />
                <DetailItem label="Why the Organization Wishes to Serve" value={reg.whyServe} />
                <DetailItem label="Governance or Blockchain Experience" value={reg.governanceExperience} />
                <DetailItem label="Communication & Transparency Approach" value={reg.communicationApproach} />

                <DetailItem label="Proof-of-Life Video Link/Description" value={reg.proofOfLifeVideoLink} isLink={reg.proofOfLifeVideoLink && reg.proofOfLifeVideoLink.startsWith('http')} />
            </div>
        );
    } else if (reg.type === 'Consortium') {
        return (
            <div className="mt-4 pt-4 border-t border-gray-200 space-y-2">
                <h4 className="text-lg font-bold text-gray-800 mb-2">Detailed Consortium Application</h4>
                <DetailItem label="Consortium Name" value={reg.name} />
                <DetailItem label="Consortium Contact Person" value={reg.primaryContactPerson} />
                <DetailItem label="Consortium Mission / Purpose" value={reg.consortiumMission} />
                <DetailItem label="Consortium Values" value={reg.consortiumValues} />

                {/* Member List */}
                <h5 className="text-md font-bold text-gray-700 mt-4 pt-2 border-t">Consortium Members ({reg.members?.length || 0})</h5>
                {reg.members?.map((member, index) => (
                    <div key={index} className="pl-4 py-2 border-l-4 border-green-300 bg-green-50 rounded-md mb-2">
                        {/* Member Name is now consistently displayed using DetailItem */}
                        <h6 className="font-bold text-sm text-green-800 mb-1 border-b border-green-200 pb-1">Member {index + 1} Details</h6>
                        <DetailItem label="Name" value={member.name} />
                        <DetailItem label="Geographic Representation" value={member.geographicRepresentation} />
                        <DetailItem label="Biography" value={member.biography} />
                        <DetailItem label="Conflict of Interest" value={member.conflictOfInterest} />
                        <DetailItem label="Stake ID" value={member.stakeId} />
                        <DetailItem label="DRep ID" value={member.drepId} />
                        <DetailItem label="Social / X Profile" value={member.socialProfile} isLink={member.socialProfile && member.socialProfile.startsWith('http')} />
                        <DetailItem 
                            label="Proof-of-Life Video Link" 
                            value={member.skipVideo ? 'Skipped (Prior Applicant - Follow-up may be required)' : member.proofOfLifeVideoLink} 
                            isLink={member.proofOfLifeVideoLink && member.proofOfLifeVideoLink.startsWith('http')}
                        />
                    </div>
                ))}
            </div>
        );
    }
    return null;
  };
  // --- End Render Detailed Application View ---

  // Render function for a single member form (Consortium)
  const renderMemberForm = (member, index) => (
    <div key={member.id} className="p-4 border border-gray-300 rounded-lg bg-gray-50 shadow-sm mb-4">
      <div className="flex justify-between items-center mb-4 border-b pb-2">
        <h4 className="text-lg font-semibold text-gray-800">Member #{index + 1}</h4>
        <button
          type="button"
          onClick={() => removeMember(member.id)}
          className="text-red-500 hover:text-red-700 transition duration-150 p-1 rounded-full hover:bg-red-100"
        >
          <Trash2 className="w-5 h-5" />
        </button>
      </div>

      {[
        { id: 'name', label: 'Name', required: true, type: 'text', icon: User, placeholder: 'Jane Doe' },
        { id: 'geographicRepresentation', label: 'Geographic Representation (Optional)', required: false, type: 'text', icon: Globe, placeholder: 'Europe / Southeast Asia' },
        { id: 'biography', label: 'Biography', required: true, type: 'textarea', icon: FileText, placeholder: 'Brief summary of background and expertise.' },
        { id: 'conflictOfInterest', label: 'Conflict of Interest (Optional)', required: false, type: 'textarea', icon: ShieldOff, placeholder: 'Declare any potential conflicts.' },
        { id: 'stakeId', label: 'Stake ID (Optional)', required: false, type: 'text', icon: Hash, placeholder: 'stake1ux0e...' },
        { id: 'drepId', label: 'DRep ID (Optional)', required: false, type: 'text', icon: Hash, placeholder: 'drep1...' },
        { id: 'socialProfile', label: 'Social / X Profile (Optional)', required: false, type: 'text', icon: Link, placeholder: '@janedoe or link' },
      ].map(field => (
        <div className="mb-3" key={field.id}>
          <label htmlFor={`member-${member.id}-${field.id}`} className="block text-sm font-medium text-gray-700 mb-1">
            {field.label} {field.required && requiredAsterisk}
          </label>
          <div className="relative">
            <field.icon className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" />
            {field.type === 'textarea' ? (
              <textarea
                id={`member-${member.id}-${field.id}`}
                rows="2"
                value={member[field.id]}
                onChange={(e) => updateMember(member.id, field.id, e.target.value)}
                placeholder={field.placeholder}
                className={`${baseInputClasses} pl-10`}
                required={field.required}
                disabled={isSubmitting}
              />
            ) : (
              <input
                id={`member-${member.id}-${field.id}`}
                type={field.type}
                value={member[field.id]}
                onChange={(e) => updateMember(member.id, field.id, e.target.value)}
                placeholder={field.placeholder}
                className={`${baseInputClasses} pl-10`}
                required={field.required}
                disabled={isSubmitting}
              />
            )}
          </div>
        </div>
      ))}
      
      {/* Proof-of-Life Video Link (Consortium Member) */}
      <div className="mt-4 border-t pt-4">
          <label htmlFor={`member-${member.id}-videoLink`} className="block text-sm font-medium text-gray-700 mb-2">
            Proof-of-Life Video link {member.skipVideo ? '' : requiredAsterisk}
          </label>

          <div className="flex items-center mb-3">
              <input 
                  id={`member-${member.id}-skipVideo`}
                  type="checkbox"
                  checked={member.skipVideo}
                  onChange={(e) => updateMember(member.id, 'skipVideo', e.target.checked)}
                  className="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
                  disabled={isSubmitting}
              />
              <label htmlFor={`member-${member.id}-skipVideo`} className="ml-2 text-sm text-gray-600 cursor-pointer">
                  Opt-out (Previously submitted proof)
              </label>
          </div>

          {!member.skipVideo ? (
              <div className="relative">
                  <p className="text-xs text-gray-500 mb-1">Provide a link (e.g., YouTube, Vimeo, or secure cloud link) to the member's video.</p>
                  <Video className="absolute left-3 top-[37px] transform -translate-y-1/2 w-5 h-5 text-gray-400" />
                  <input
                      id={`member-${member.id}-videoLink`}
                      type="url"
                      value={member.proofOfLifeVideoLink}
                      onChange={(e) => updateMember(member.id, 'proofOfLifeVideoLink', e.target.value)}
                      placeholder="https://youtu.be/member-proof-of-life"
                      className={`${baseInputClasses} pl-10`}
                      required
                      disabled={isSubmitting}
                  />
              </div>
          ) : (
              <p className="text-sm text-yellow-700 bg-yellow-100 p-2 rounded-lg border-l-4 border-yellow-500">
                  ⚠️ Opt-out selected. Follow-up verification may be required if information is uncertain.
              </p>
          )}
      </div>
    </div>
  );
  // --- End Member Form Render Function ---

  return (
    <div className="min-h-screen bg-gray-50 p-4 sm:p-8">
      <div className="max-w-4xl mx-auto">
        <h1 className="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2 border-b-4 border-indigo-600 pb-2">
          Constitutional Committee Application
        </h1>
        <p className="text-gray-600 mb-6 sm:mb-8 text-lg">
          Submit your detailed application to serve on the Constitutional Committee.
        </p>

        {/* User ID Display */}
        <div className="mb-6 p-3 bg-indigo-50 border-l-4 border-indigo-500 text-indigo-700 rounded-lg">
            <p className="font-semibold text-sm">Your unique submitter ID (for reference):</p>
            <p className="text-xs break-all">{userId}</p>
        </div>

        {/* Status Messages */}
        {error && (
          <div className="flex items-center p-3 mb-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
            <AlertTriangle className="w-5 h-5 mr-2" />
            <span className="font-medium">{error}</span>
          </div>
        )}
        {submissionSuccess && (
          <div className="flex items-center p-3 mb-4 bg-green-100 border border-green-400 text-green-700 rounded-lg">
            <CheckCircle className="w-5 h-5 mr-2" />
            <span className="font-medium">Application successful! Thank you for your submission.</span>
          </div>
        )}

        {/* Application Form */}
        <div className="bg-white shadow-xl rounded-xl p-6 sm:p-8 mb-10">
          <form onSubmit={handleSubmit}>
            <h2 className="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">1. Entity Type Selection</h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              {['Individual', 'Company', 'Consortium'].map((type) => (
                <button
                  key={type}
                  type="button"
                  onClick={() => {
                    setRegistrationType(type);
                    setError('');
                  }}
                  className={`p-4 rounded-xl border-2 transition-all duration-200 shadow-md ${
                    registrationType === type
                      ? 'bg-indigo-600 border-indigo-700 text-white font-semibold transform scale-105'
                      : 'bg-white border-gray-300 text-gray-700 hover:bg-indigo-50 hover:border-indigo-400'
                  }`}
                >
                  {type === 'Company' ? 'Company / Organization' : type}
                </button>
              ))}
            </div>

            <h2 className="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">2. Application Details</h2>

            {/* Entity Name Field (Common) */}
            <div className="mb-4">
              <label htmlFor="entityName" className="block text-sm font-medium text-gray-700 mb-1">
                {registrationType === 'Individual' ? 'Full Name or Alias' : registrationType === 'Company' ? 'Company / Organisation Name' : 'Consortium Name'} {requiredAsterisk}
              </label>
              <div className="relative">
                <User className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" />
                <input
                  id="entityName"
                  type="text"
                  value={entityName}
                  onChange={(e) => setEntityName(e.target.value)}
                  placeholder={registrationType === 'Individual' ? 'Alice Smith' : 'Global Governance Corp'}
                  className={`${baseInputClasses} pl-10`}
                  required
                  disabled={isSubmitting}
                />
              </div>
            </div>

            {/* Primary Contact Person (Company/Consortium) */}
            {(registrationType === 'Company' || registrationType === 'Consortium') && (
              <div className="mb-4">
                <label htmlFor="primaryContactPerson" className="block text-sm font-medium text-gray-700 mb-1">
                  Primary Contact Person {requiredAsterisk}
                </label>
                <div className="relative">
                  <User className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" />
                  <input
                    id="primaryContactPerson"
                    type="text"
                    value={primaryContactPerson}
                    onChange={(e) => setPrimaryContactPerson(e.target.value)}
                    placeholder="Name of the main representative"
                    className={`${baseInputClasses} pl-10`}
                    required
                    disabled={isSubmitting}
                  />
                </div>
              </div>
            )}

            {/* Contact Email Field (Common) */}
            <div className="mb-6">
              <label htmlFor="contactEmail" className="block text-sm font-medium text-gray-700 mb-1">
                Primary Contact Email {requiredAsterisk}
              </label>
              <div className="relative">
                <Mail className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" />
                <input
                  id="contactEmail"
                  type="email"
                  value={contactEmail}
                  onChange={(e) => setContactEmail(e.target.value)}
                  placeholder="contact@entity.com"
                  className={`${baseInputClasses} pl-10`}
                  required
                  disabled={isSubmitting}
                />
              </div>
            </div>

            {/* --- INDIVIDUAL FIELDS --- */}
            {registrationType === 'Individual' && (
              <div className="space-y-6 p-6 bg-indigo-50 border border-indigo-200 rounded-xl">
                <h3 className="text-xl font-bold text-indigo-800">Individual Candidacy</h3>

                {/* Geo Rep */}
                <div className="relative">
                  <label htmlFor="geoRep" className="block text-sm font-medium text-gray-700 mb-1">Geographic Representation (Optional)</label>
                  <Globe className="absolute left-3 top-9 transform -translate-y-1/2 w-5 h-5 text-gray-400" />
                  <input id="geoRep" type="text" value={geographicRepresentation} onChange={(e) => setGeographicRepresentation(e.target.value)}
                    placeholder="Continent, Country, or Region you represent" className={`${baseInputClasses} pl-10`} disabled={isSubmitting} />
                </div>

                {/* Biography */}
                <div className="relative">
                  <label htmlFor="bio" className="block text-sm font-medium text-gray-700 mb-1">Biography {requiredAsterisk}</label>
                  <FileText className="absolute left-3 top-4 w-5 h-5 text-gray-400" />
                  <textarea id="bio" rows="4" value={biography} onChange={(e) => setBiography(e.target.value)}
                    placeholder="Provide a detailed summary of your professional and community background (Min 250 words suggested)" className={`${baseInputClasses} pl-10`} required disabled={isSubmitting} />
                </div>

                {/* Conflict of Interest */}
                <div className="relative">
                  <label htmlFor="coi" className="block text-sm font-medium text-gray-700 mb-1">Conflict of Interest (Optional)</label>
                  <ShieldOff className="absolute left-3 top-9 transform -translate-y-1/2 w-5 h-5 text-gray-400" />
                  <input id="coi" type="text" value={conflictOfInterest} onChange={(e) => setConflictOfInterest(e.target.value)}
                    placeholder="Declare any potential conflicts (e.g., employment, funding)" className={`${baseInputClasses} pl-10`} disabled={isSubmitting} />
                </div>

                {/* IDs and Social */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  {[
                    { id: 'stakeId', label: 'Stake ID (Optional)', state: stakeId, setter: setStakeId, icon: Hash, placeholder: 'stake1...' },
                    { id: 'drepId', label: 'DRep ID (Optional)', state: drepId, setter: setDrepId, icon: Hash, placeholder: 'drep1...' },
                    { id: 'socialProfile', label: 'Social / X Profile (Optional)', state: socialProfile, setter: setSocialProfile, icon: Link, placeholder: '@profile or link' },
                  ].map(field => (
                    <div className="relative" key={field.id}>
                      <label htmlFor={field.id} className="block text-sm font-medium text-gray-700 mb-1">{field.label}</label>
                      <field.icon className="absolute left-3 top-9 transform -translate-y-1/2 w-5 h-5 text-gray-400" />
                      <input id={field.id} type="text" value={field.state} onChange={(e) => field.setter(e.target.value)}
                        placeholder={field.placeholder} className={`${baseInputClasses} pl-10`} disabled={isSubmitting} />
                    </div>
                  ))}
                </div>

                {/* Proof-of-Life Video Link (with Opt-out) */}
                <div className="mt-6 border-t pt-4">
                    <label htmlFor="videoLink" className="block text-sm font-medium text-gray-700 mb-2">
                        Proof-of-Life Video link {skipVideo ? '' : requiredAsterisk}
                    </label>

                    <div className="flex items-center mb-3">
                        <input 
                            id="skipVideo"
                            type="checkbox"
                            checked={skipVideo}
                            onChange={(e) => setSkipVideo(e.target.checked)}
                            className="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
                            disabled={isSubmitting}
                        />
                        <label htmlFor="skipVideo" className="ml-2 text-sm text-gray-600 cursor-pointer">
                            Opt-out (Previously submitted proof in an earlier election)
                        </label>
                    </div>

                    {!skipVideo ? (
                        <div className="relative">
                            <p className="text-xs text-gray-500 mb-1">Provide a link (e.g., YouTube, Vimeo, or secure cloud storage) to your video.</p>
                            <Video className="absolute left-3 top-[37px] transform -translate-y-1/2 w-5 h-5 text-gray-400" />
                            <input id="videoLink" type="url" value={proofOfLifeVideoLink} onChange={(e) => setProofOfLifeVideoLink(e.target.value)}
                                placeholder="https://youtu.be/your-proof-of-life" className={`${baseInputClasses} pl-10`} required disabled={isSubmitting} />
                        </div>
                    ) : (
                        <p className="text-sm text-yellow-700 bg-yellow-100 p-2 rounded-lg border-l-4 border-yellow-500">
                            ⚠️ Opt-out selected. If there is uncertainty regarding the correctness of the information, follow-up verification may be required.
                        </p>
                    )}
                </div>

                {/* Motivation */}
                <div className="relative">
                  <label htmlFor="motivation" className="block text-sm font-medium text-gray-700 mb-1">Motivation for Serving {requiredAsterisk}</label>
                  <Briefcase className="absolute left-3 top-4 w-5 h-5 text-gray-400" />
                  <textarea id="motivation" rows="3" value={motivation} onChange={(e) => setMotivation(e.target.value)}
                    placeholder="Explain why you are seeking this role and what you hope to achieve." className={`${baseInputClasses} pl-10`} required disabled={isSubmitting} />
                </div>

                {/* Relevant Experience */}
                <div className="relative">
                  <label htmlFor="experience" className="block block text-sm font-medium text-gray-700 mb-1">Relevant Governance or Constitutional Experience {requiredAsterisk}</label>
                  <FileText className="absolute left-3 top-4 w-5 h-5 text-gray-400" />
                  <textarea id="experience" rows="3" value={relevantExperience} onChange={(e) => setRelevantExperience(e.target.value)}
                    placeholder="Detail your experience in constitutional, governance, or similar high-stakes roles." className={`${baseInputClasses} pl-10`} required disabled={isSubmitting} />
                </div>

                {/* Communication & Transparency Approach */}
                <div className="relative">
                  <label htmlFor="commApproach" className="block text-sm font-medium text-gray-700 mb-1">Communication & Transparency Approach {requiredAsterisk}</label>
                  <Users className="absolute left-3 top-4 w-5 h-5 text-gray-400" />
                  <textarea id="commApproach" rows="3" value={communicationApproach} onChange={(e) => setCommunicationApproach(e.target.value)}
                    placeholder="Outline your strategy for transparent communication with the community." className={`${baseInputClasses} pl-10`} required disabled={isSubmitting} />
                </div>

              </div>
            )}

            {/* --- COMPANY / ORGANIZATION FIELDS --- */}
            {registrationType === 'Company' && (
              <div className="space-y-6 p-6 bg-yellow-50 border border-yellow-200 rounded-xl">
                <h3 className="text-xl font-bold text-yellow-800">Company/Organization Candidacy</h3>

                {/* Org Description */}
                <div className="relative">
                  <label htmlFor="orgDesc" className="block text-sm font-medium text-gray-700 mb-1">Organization Description {requiredAsterisk}</label>
                  <FileText className="absolute left-3 top-4 w-5 h-5 text-gray-400" />
                  <textarea id="orgDesc" rows="4" value={organizationDescription} onChange={(e) => setOrganizationDescription(e.target.value)}
                    placeholder="Provide a summary of your organization's mission, size, and primary activities." className={`${baseInputClasses} pl-10`} required disabled={isSubmitting} />
                </div>

                {/* Conflict of Interest */}
                <div className="relative">
                  <label htmlFor="coiComp" className="block text-sm font-medium text-gray-700 mb-1">Conflict of Interest (Optional)</label>
                  <ShieldOff className="absolute left-3 top-9 transform -translate-y-1/2 w-5 h-5 text-gray-400" />
                  <input id="coiComp" type="text" value={conflictOfInterest} onChange={(e) => setConflictOfInterest(e.target.value)}
                    placeholder="Declare any potential conflicts." className={`${baseInputClasses} pl-10`} disabled={isSubmitting} />
                </div>

                {/* Proof-of-Life Video Link (treated as link/description - NO OPT-OUT for company, as it relates to the org) */}
                <div className="relative">
                  <label htmlFor="videoLinkComp" className="block text-sm font-medium text-gray-700 mb-1">Proof-of-Life Video Link/Description {requiredAsterisk}</label>
                  <p className="text-xs text-gray-500 mb-1">Provide a link or description of the video showcasing the organization's commitment.</p>
                  <Video className="absolute left-3 top-[37px] transform -translate-y-1/2 w-5 h-5 text-gray-400" />
                  <input id="videoLinkComp" type="text" value={proofOfLifeVideoLink} onChange={(e) => setProofOfLifeVideoLink(e.target.value)}
                    placeholder="Link to video or description of file access" className={`${baseInputClasses} pl-10`} required disabled={isSubmitting} />
                </div>

                {/* Governance Experience */}
                <div className="relative">
                  <label htmlFor="govExpComp" className="block text-sm font-medium text-gray-700 mb-1">Governance or Blockchain Experience {requiredAsterisk}</label>
                  <Briefcase className="absolute left-3 top-4 w-5 h-5 text-gray-400" />
                  <textarea id="govExpComp" rows="3" value={governanceExperience} onChange={(e) => setGovernanceExperience(e.target.value)}
                    placeholder="Detail the organization's relevant experience in governance or blockchain spaces." className={`${baseInputClasses} pl-10`} required disabled={isSubmitting} />
                </div>

                {/* Communication & Transparency Approach */}
                <div className="relative">
                  <label htmlFor="commApproachComp" className="block text-sm font-medium text-gray-700 mb-1">Communication & Transparency Approach {requiredAsterisk}</label>
                  <Users className="absolute left-3 top-4 w-5 h-5 text-gray-400" />
                  <textarea id="commApproachComp" rows="3" value={communicationApproach} onChange={(e) => setCommunicationApproach(e.target.value)}
                    placeholder="How will the organization communicate its activities to the community?" className={`${baseInputClasses} pl-10`} required disabled={isSubmitting} />
                </div>

                {/* Why Serve */}
                <div className="relative">
                  <label htmlFor="whyServe" className="block text-sm font-medium text-gray-700 mb-1">Why the Organization Wishes to Serve {requiredAsterisk}</label>
                  <FileText className="absolute left-3 top-4 w-5 h-5 text-gray-400" />
                  <textarea id="whyServe" rows="3" value={whyServe} onChange={(e) => setWhyServe(e.target.value)}
                    placeholder="State the organization's motivation for participation." className={`${baseInputClasses} pl-10`} required disabled={isSubmitting} />
                </div>

              </div>
            )}

            {/* --- CONSORTIUM FIELDS --- */}
            {registrationType === 'Consortium' && (
              <div className="space-y-6 p-6 bg-green-50 border border-green-200 rounded-xl">
                <h3 className="text-xl font-bold text-green-800">Consortium Application</h3>

                {/* Mission */}
                <div className="relative">
                  <label htmlFor="mission" className="block text-sm font-medium text-gray-700 mb-1">Consortium Mission / Purpose (Optional)</label>
                  <FileText className="absolute left-3 top-4 w-5 h-5 text-gray-400" />
                  <textarea id="mission" rows="2" value={consortiumMission} onChange={(e) => setConsortiumMission(e.target.value)}
                    placeholder="Briefly describe the consortium's long-term goals." className={`${baseInputClasses} pl-10`} disabled={isSubmitting} />
                </div>

                {/* Values */}
                <div className="relative">
                  <label htmlFor="values" className="block text-sm font-medium text-gray-700 mb-1">Consortium Values (Optional)</label>
                  <Users className="absolute left-3 top-4 w-5 h-5 text-gray-400" />
                  <textarea id="values" rows="2" value={consortiumValues} onChange={(e) => setConsortiumValues(e.target.value)}
                    placeholder="Core values that guide the consortium's decisions." className={`${baseInputClasses} pl-10`} disabled={isSubmitting} />
                </div>

                <div className="mt-8 border-t pt-4">
                  <div className="flex justify-between items-center mb-4">
                    <h4 className="text-lg font-bold text-gray-800">Consortium Members {requiredAsterisk}</h4>
                    <button
                      type="button"
                      onClick={addMember}
                      className="flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-800 transition duration-150 p-2 rounded-lg bg-indigo-100 hover:bg-indigo-200"
                    >
                      <PlusCircle className="w-5 h-5 mr-1" /> Add Member
                    </button>
                  </div>
                  {consortiumMembers.map(renderMemberForm)}
                  {consortiumMembers.length === 0 && (
                    <p className="text-sm text-gray-500 p-3 border border-dashed rounded-lg text-center">
                      Click 'Add Member' to start listing the individuals representing the consortium.
                    </p>
                  )}
                </div>

              </div>
            )}

            {/* Disclaimer at the bottom */}
            <div className="mt-8 pt-6 border-t border-gray-300">
                <p className="text-xs text-gray-500 italic leading-relaxed">
                    This application form is administered by **Intersect MBO** for the Constitutional Committee snap election. Information submitted may be reviewed, verified, and publicly published to support election transparency and community oversight. By submitting this application, you acknowledge that all information provided is accurate to the best of your knowledge and consent to its use for governance, verification, and publication purposes. Submission does not guarantee placement in the Constitutional Committee. For official updates, please follow **@IntersectMBO** across verified channels.
                </p>
            </div>

            <button
              type="submit"
              className="w-full mt-6 flex items-center justify-center px-6 py-3 border border-transparent text-lg font-medium rounded-xl shadow-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 disabled:opacity-50"
              disabled={isSubmitting}
            >
              {isSubmitting ? (
                <>
                  <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                  Submitting Application...
                </>
              ) : (
                'Submit Constitutional Committee Application'
              )}
            </button>
          </form>
        </div>

        {/* Real-Time Applications Display */}
        <div className="mt-10">
          <h2 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">
            Current Applications ({registrations.length})
          </h2>
          {registrations.length === 0 ? (
            <div className="p-4 text-center text-gray-500 bg-white rounded-lg shadow-md">
              No applications submitted yet.
            </div>
          ) : (
            <div className="space-y-4">
              {registrations.map((reg) => {
                const isExpanded = expandedId === reg.id;
                return (
                  <div key={reg.id} className={`bg-white p-5 rounded-xl shadow-md border-l-4 transition-all duration-300 cursor-pointer ${
                    isExpanded ? 'border-indigo-600 ring-2 ring-indigo-300' : 'border-indigo-400 hover:shadow-lg'
                  }`}>
                    
                    {/* Summary Header & Toggle Button */}
                    <div className="flex justify-between items-center" onClick={() => toggleExpand(reg.id)}>
                      <div>
                        <div className="flex items-center mb-1">
                          <span className={`px-3 py-1 text-xs font-semibold rounded-full ${
                            reg.type === 'Individual' ? 'bg-blue-100 text-blue-800' :
                            reg.type === 'Company' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-green-100 text-green-800'
                          } mr-2`}>
                            {reg.type === 'Company' ? 'Company / Org' : reg.type}
                          </span>
                          <h3 className="text-xl font-bold text-gray-900">{reg.name}</h3>
                        </div>
                        <p className="text-sm text-gray-600">
                          Contact: {reg.contactEmail} 
                          <span className="text-xs text-gray-500 ml-3">
                            (Submitted: {reg.timestamp ? new Date(reg.timestamp.toDate()).toLocaleString() : 'Processing...'})
                          </span>
                        </p>
                      </div>
                      <button type="button" className="p-2 text-indigo-600 hover:text-indigo-800 transition duration-150">
                        {isExpanded ? <ChevronUp className="w-6 h-6" /> : <ChevronDown className="w-6 h-6" />}
                      </button>
                    </div>

                    {/* Detailed Content (Conditional Rendering) */}
                    {isExpanded && renderDetailedApplication(reg)}

                  </div>
                );
              })}
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default App;
